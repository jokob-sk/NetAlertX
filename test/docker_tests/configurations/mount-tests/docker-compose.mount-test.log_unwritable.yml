# Expected outcome: Container fails to start due to unwritable log partition
# - NETALERTX_LOG shows as mounted but unwritable (‚ùå in Writeable column)
# - 25-mandatory-folders.sh cannot create required log files and fails
# - Container startup fails because logging infrastructure cannot be initialized
services:
  netalertx:
    network_mode: host
    build:
      context: ../../../
      dockerfile: Dockerfile
    image: netalertx-test
    container_name: netalertx-test-mount-log_unwritable
    cap_drop:
      - ALL
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - NET_BIND_SERVICE
    environment:
      LISTEN_ADDR: 0.0.0.0
      PORT: 9999  # Use non-default port to test all paths
      APP_CONF_OVERRIDE: 20212
      ALWAYS_FRESH_INSTALL: true
      NETALERTX_DEBUG: 0
      NETALERTX_LOG: /tmp/log

    volumes:
      - type: volume
        source: netalertx_db
        target: /data/db
        read_only: false
      - type: volume
        source: netalertx_config
        target: /data/config
        read_only: false
      - type: volume
        source: test_netalertx_log
        target: /tmp/log
        read_only: true
    tmpfs:
      - "/tmp/api:uid=20211,gid=20211,mode=1700,rw,noexec,nosuid,nodev,async,noatime,nodiratime"
      - "/tmp/run:uid=20211,gid=20211,mode=1700,rw,noexec,nosuid,nodev,async,noatime,nodiratime"
      - "/tmp/nginx/active-config:uid=20211,gid=20211,mode=1700,rw,noexec,nosuid,nodev,async,noatime,nodiratime"
volumes:
  netalertx_config:
  netalertx_db:
  test_netalertx_db:
  test_netalertx_config:
  test_netalertx_api:
  test_netalertx_log:
  test_system_services_run:
  test_system_services_active_config:
