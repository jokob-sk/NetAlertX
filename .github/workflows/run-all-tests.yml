name: Manual Test Suite Selector

on:
  workflow_dispatch:
    inputs:
      run_authoritative:
        description: 'ðŸ“‚ authoritative_fields/ (Logic, Locks, IPs)'
        type: boolean
        default: true
      run_api:
        description: 'ðŸ“‚ api_endpoints/ & server/ (Endpoints & Server)'
        type: boolean
        default: false
      run_backend:
        description: 'ðŸ“‚ backend/ (SQL Builder & Security)'
        type: boolean
        default: false
      run_docker_env:
        description: 'ðŸ“‚ docker_tests/ (Environment & PUID/PGID)'
        type: boolean
        default: false
      run_ui:
        description: 'ðŸ“‚ ui/ (Selenium & Dashboard)'
        type: boolean
        default: false
      run_root_files:
        description: 'ðŸ“„ Root Test Files (WOL, Atomicity, etc.)'
        type: boolean
        default: false

jobs:
  comprehensive-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Environment
        run: sudo apt-get update && sudo apt-get install -y sqlite3

      - name: Build Test Path Command
        id: builder
        run: |
          PATHS=""
          # Folder Mapping
          if [ "${{ github.event.inputs.run_authoritative }}" == "true" ]; then PATHS="$PATHS authoritative_fields/"; fi
          if [ "${{ github.event.inputs.run_api }}" == "true" ]; then PATHS="$PATHS api_endpoints/ server/"; fi
          if [ "${{ github.event.inputs.run_backend }}" == "true" ]; then PATHS="$PATHS backend/"; fi
          if [ "${{ github.event.inputs.run_docker_env }}" == "true" ]; then PATHS="$PATHS docker_tests/"; fi
          if [ "${{ github.event.inputs.run_ui }}" == "true" ]; then PATHS="$PATHS ui/"; fi

          # Root Files Mapping (Selects test_*.py directly in /test/)
          if [ "${{ github.event.inputs.run_root_files }}" == "true" ]; then
            PATHS="$PATHS test_device_atomicity.py test_mcp_disablement.py test_plugin_helper.py test_wol_validation.py"
          fi

          # Default to root if somehow nothing is selected
          if [ -z "$PATHS" ]; then PATHS="."; fi

          echo "final_paths=$PATHS" >> $GITHUB_OUTPUT

      - name: Run Docker Integration Script
        run: |
          chmod +x ./test/docker_tests/run_docker_tests.sh

          # We update the pytest command to use the specific paths built above.
          # Note: We still keep your 'not' filter to skip E2E tests unless you want them.
          TARGET_PATHS="${{ steps.builder.outputs.final_paths }}"
          SED_COMMAND="pytest $TARGET_PATHS -m 'not (docker or compose or feature_complete)'"

          echo "ðŸš€ Targeted Pytest Command: $SED_COMMAND"

          sed -i "s|pytest -m 'not (docker or compose or feature_complete)'|$SED_COMMAND|g" ./test/docker_tests/run_docker_tests.sh

          ./test/docker_tests/run_docker_tests.sh

      - name: Cleanup
        if: always()
        run: |
          docker stop netalertx-test-container || true
          docker rm netalertx-test-container || true